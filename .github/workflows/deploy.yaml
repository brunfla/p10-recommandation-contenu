name: Build and Deploy

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v3

      - name: üêç Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: üì¶ Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: üì¶ Install Python dependencies
        run: |
          pip install -r requirements.txt

      - name: üõ† Install AzCopy
        run: |
          wget https://aka.ms/downloadazcopy-v10-linux -O azcopy.tar.gz
          tar -xf azcopy.tar.gz
          sudo cp ./azcopy_linux_amd64_*/azcopy /usr/bin/

      - name: ‚öôÔ∏è Configure DVC remote credentials
        run: |
          dvc remote modify azure-p10 account_name $DVC_ACCOUNT_NAME --local
          dvc remote modify azure-p10 account_key $DVC_ACCOUNT_KEY --local
        env:
          DVC_ACCOUNT_NAME: ${{ secrets.DVC_ACCOUNT_NAME }}
          DVC_ACCOUNT_KEY: ${{ secrets.DVC_ACCOUNT_KEY }}

      - name: ‚¨áÔ∏è Pull data and model from DVC remote
        run: dvc pull

      - name: üîÅ DVC repro with GitHub params
        run: dvc repro

      - name: ‚òÅÔ∏è Push model & data to DVC remote
        run: dvc push

      - name: üîê Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ‚úÖ Upload trained model to Azure Blob
        run: |
          azcopy copy data/outs/model/model_svd.pkl "$MODEL_SAS_URL" --overwrite=true
        env:
          MODEL_SAS_URL: ${{ secrets.MODEL_SAS_URL }}

      - name: üîê Inject MODEL_SAS_URL in Azure Function config
        run: |
          az functionapp config appsettings set \
            --name "$AZURE_FUNCTION_NAME" \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --settings 'MODEL_SAS_URL='"$MODEL_SAS_URL"
        env:
          MODEL_SAS_URL: ${{ secrets.MODEL_SAS_URL }}
          AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
          AZURE_FUNCTION_NAME: ${{ secrets.AZURE_FUNCTION_NAME }}

      - name: üöÄ Deploy Azure Function
        run: |
          func azure functionapp publish $AZURE_FUNCTION_NAME --python

      - name: üé® (Optionnel) Deploy Streamlit App
        if: false  # change to true or remove this line to enable
        run: |
          echo "Streamlit deployment logic goes here"

