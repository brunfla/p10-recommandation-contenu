name: Build and Deploy

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v3

      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: ðŸ“¦ Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: ðŸ“¦ Install Python dependencies
        run: |
          pip install -r requirements.txt

      - name: ðŸ›  Install AzCopy
        run: |
          wget https://aka.ms/downloadazcopy-v10-linux -O azcopy.tar.gz
          tar -xf azcopy.tar.gz
          sudo cp ./azcopy_linux_amd64_*/azcopy /usr/bin/

      - name: ðŸ“¦ Install Azure Functions Core Tools
        run: |
          npm install -g azure-functions-core-tools@4 --unsafe-perm true

      - name: ðŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: âš™ï¸ Configure DVC remote credentials
        run: |
          dvc remote modify azure-p10 account_name $DVC_ACCOUNT_NAME --local
          dvc remote modify azure-p10 account_key $DVC_ACCOUNT_KEY --local
        env:
          DVC_ACCOUNT_NAME: ${{ secrets.DVC_ACCOUNT_NAME }}
          DVC_ACCOUNT_KEY: ${{ secrets.DVC_ACCOUNT_KEY }}

      - name: â¬‡ï¸ Pull data and model from DVC remote (if applicable)
        run: |
          if [ -f dvc.lock ] || [ -f dvc.yaml ]; then
            dvc pull
          else
            echo "âš ï¸ No DVC metadata found to pull from remote."
          fi

      - name: ðŸ” DVC repro
        run: dvc repro
        env:
          MODEL_SAS_URL: ${{ secrets.MODEL_SAS_URL }}
          AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
          AZURE_FUNCTION_NAME: ${{ secrets.AZURE_FUNCTION_NAME }}

      - name: â˜ï¸ Push model & data to DVC remote
        run: dvc push

      - name: ðŸ“ Commit updated DVC metadata (if changed)
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add dvc.lock dvc.yaml
          git diff --cached --quiet || git commit -m "ðŸ”„ Update DVC metadata [CI]"
          git push

#      - name: ðŸ” Hash secrets
#        run: |
#          echo -n "$MODEL_SAS_URL" | sha256sum | cut -d ' ' -f1 > data/deps/github/MODEL_SAS_URL.hash
#          echo -n "$AZURE_RESOURCE_GROUP" | sha256sum | cut -d ' ' -f1 > data/deps/github/AZURE_RESOURCE_GROUP.hash
#          echo -n "$AZURE_FUNCTION_NAME" | sha256sum | cut -d ' ' -f1 > data/deps/github/AZURE_FUNCTION_NAME.hash
#        env:
#          MODEL_SAS_URL: ${{ secrets.MODEL_SAS_URL }}
#          AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
#          AZURE_FUNCTION_NAME: ${{ secrets.AZURE_FUNCTION_NAME }}

